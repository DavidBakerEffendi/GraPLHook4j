version: "3.4"

services:
  janusgraph:
    image: janusgraph/janusgraph:0.5.1
    container_name: janusgraph-grapl
    environment:
      JANUS_PROPS_TEMPLATE: cql-es
      janusgraph.storage.backend: cql
      janusgraph.storage.hostname: scylla-grapl
      janusgraph.index.search.hostname: elastic-grapl
    ports:
      - "8182:8182"
    healthcheck:
      test: ["CMD-SHELL", "bin/gremlin.sh", "-e", "scripts/remote-connect.groovy"]
      interval: 5s
      timeout: 20s
      retries: 3
      start_period: 30s
    volumes:
      - "./janusgraph_schema.groovy:/docker-entrypoint-initdb.d/schema.groovy"
    networks:
      - jg-grapl-network
  scylla:
    image: scylladb/scylla:4.0.0
    container_name: scylla-grapl
    command:
      - "--smp"
      - "2"
    ports:
      # REST API
      - "10000:10000"
      # CQL ports (native_transport_port)
      - "9042:9042"
      # Thrift (rpc_port)
      - "9160:9160"
      # Internode
      - "7000:7000"
      - "7001:7001"
      # JMX
      - "7199:7199"
      # Prometheus monitoring
      - "9180:9180"
      - "9100:9100"
    healthcheck:
      test: ["CMD-SHELL", "[ $$(nodetool statusgossip) = running ]"]
      interval: 30s
      timeout: 10s
      retries: 5
    volumes:
      - "jg-grapl-scylla:/var/lib/scylla"
    networks:
      - jg-grapl-network
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.6.2
    container_name: elastic-grapl
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - discovery.type=single-node
      - http.host=0.0.0.0
      - transport.host=127.0.0.1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 1s
      timeout: 30s
      retries: 30
    user: "1000"
    volumes:
      - "jg-grapl-es:/usr/share/elasticsearch/data"
    networks:
      - jg-grapl-network

networks:
  jg-grapl-network:
volumes:
  jg-grapl-scylla:
  jg-grapl-es: